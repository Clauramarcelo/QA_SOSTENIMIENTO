<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CE - Control de Calidad (Offline)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#E5E7EB"/>
  <link rel="stylesheet" href="styles.css" />
  <!-- PyScript (CDN). Para funcionamiento 100% offline, mover a vendor local y precache en sw.js -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2026.1.1/core.css" />
  <script type="module" src="https://pyscript.net/releases/2026.1.1/core.js"></script>
</head>
<body>
<header class="app-header">
  <div class="brand">
    <div class="logo">CE</div>
    <div class="brand-text">
      <div class="title">Control de Calidad - Sostenimiento</div>
      <div class="subtitle">Offline • Datos guardados en el dispositivo</div>
    </div>
  </div>
</header>

<nav class="tabs" role="tablist" aria-label="Pestañas">
  <button class="tab active" data-tab="slump" role="tab" aria-selected="true">1. Slump y T°</button>
  <button class="tab" data-tab="resist" role="tab" aria-selected="false">2. Resistencias iniciales</button>
  <button class="tab" data-tab="pernos" role="tab" aria-selected="false">3. Pernos</button>
  <button class="tab" data-tab="bd" role="tab" aria-selected="false">4. Base de Datos</button>
  <button class="tab" data-tab="reporte" role="tab" aria-selected="false">5. Reporte</button>
</nav>

<main class="container">
  <!-- TAB 1: SLUMP -->
  <section id="tab-slump" class="panel active" role="tabpanel">
    <div class="panel-head">
      <h2>Slump y Temperatura</h2>
      <p class="muted">Registro de control (Slump en pulgadas) + variables de mezcla.</p>
    </div>
    <form id="formSlump" class="card">
      <div class="slump-layout">
        <div class="slump-main">
          <div class="grid grid-4">
            <div>
              <label>Fecha</label>
              <input type="date" name="fecha" required />
            </div>
            <div>
              <label>Labor</label>
              <input type="text" name="labor" placeholder="Ej. NV-520 Rampa 3" required />
            </div>
            <div>
              <label>Nivel</label>
              <input type="text" name="nivel" placeholder="Ej. 520" required />
            </div>
            <div>
              <label>Operador (opcional)</label>
              <input type="text" name="operador" placeholder="Opcional" />
            </div>
          </div>

          <div class="grid grid-4 mt-12">
            <div>
              <label>Slump (pulgadas)</label>
              <input type="text" name="slumpIn" placeholder='Ej. 9 3/4" \n 10 1/4" \n 9.75"' required />
              <small class="hint">Acepta: 9 3/4", 10 1/4", 7/8", 9.75"</small>
            </div>
            <div>
              <label>Temperatura (°C)</label>
              <input type="number" name="temp" step="0.1" placeholder="Ej. 18.5" required />
            </div>
            <div>
              <label>Presión de aire</label>
              <input type="number" name="presionAire" step="0.1" placeholder="Ej. 6.5" required />
            </div>
            <div>
              <label>N° Mixer</label>
              <input type="text" name="mixerNo" placeholder="Ej. Mixer 07" required />
            </div>
          </div>

          <div class="grid mt-12">
            <div class="col-span-2">
              <label>Observaciones</label>
              <input type="text" name="obs" placeholder="Opcional" />
            </div>
          </div>

          <div class="actions">
            <button class="btn" type="submit">Guardar</button>
            <button class="btn btn-secondary" type="reset">Limpiar</button>
          </div>
          <div class="inline-status" id="slumpStatus" aria-live="polite"></div>
        </div>

        <!-- HORAS -->
        <aside class="slump-hours">
          <div class="hours-card">
            <div class="hours-title">Horas</div>
            <div class="hours-grid">
              <div>
                <label>1. Hora de salida (HS)</label>
                <input type="time" name="hsOut" required />
              </div>
              <div>
                <label>2. Hora llegada (H_LL)</label>
                <input type="time" name="hll" required />
              </div>
              <div>
                <label>3. Hora del Slump</label>
                <input type="time" name="horaSlump" required />
              </div>
              <div>
                <label>4. Demora (H_LL - HS)</label>
                <input type="text" name="demora" readonly placeholder="Se calcula automáticamente" />
              </div>
            </div>
            <div class="hint mt-12">La demora se calcula como H_LL - HS (si cruza medianoche, se ajusta).</div>
          </div>
        </aside>
      </div>
    </form>
  </section>

  <!-- TAB 2: RESISTENCIAS INICIALES -->
  <section id="tab-resist" class="panel" role="tabpanel">
    <div class="panel-head">
      <h2>Resistencias iniciales — UNE EN 14488-2</h2>
      <p class="muted">
        Ingreso según Método A (Penetrómetro, 5 fuerzas N) o Método B (Hilti). Se calcula Promedio/Relación y MPa con la curva de calibración seleccionada.
      </p>
    </div>

    <form id="formResist" class="card">
      <div class="grid">
        <div>
          <label>Fecha</label>
          <input type="date" name="fecha" required />
        </div>
        <div>
          <label>Hora de muestreo base (HRS)</label>
          <input type="time" name="horaBase" required />
        </div>
        <div>
          <label>Labor</label>
          <input type="text" name="labor" required />
        </div>
        <div>
          <label>Nivel</label>
          <input type="text" name="nivel" required />
        </div>
      </div>

      <div class="grid mt-12">
        <div>
          <label>Método</label>
          <select name="metodo" id="metodo" required>
            <option value="A">A — Penetrómetro</option>
            <option value="B">B — Hilti</option>
          </select>
        </div>
        <div>
          <label>Curva de calibración</label>
          <select name="curva" id="curva">
            <option value="II">II (0–16 mm)</option>
            <option value="I">I</option>
            <option value="III">III</option>
          </select>
        </div>
        <div class="col-span-2">
          <label>Observaciones</label>
          <input type="text" name="obs" placeholder="Opcional" />
        </div>
      </div>

      <!-- MÉTODO A -->
      <div id="resA" class="card mt-12">
        <h3>Método A — Penetrómetro (5 fuerzas N por lectura)</h3>
        <div class="hint">Ingresa una o varias lecturas; la “hora acumulada” se calcula desde la hora base.</div>
        <div id="areaA"></div>
        <div class="actions left">
          <button type="button" id="addRowA" class="btn">Agregar lectura A</button>
        </div>
      </div>

      <!-- MÉTODO B -->
      <div id="resB" class="card mt-12" style="display:none">
        <h3>Método B — Hilti</h3>
        <div class="hint">Completa los parámetros por lectura (Longitudes, Pull-out). Calcula Relación N/mm y MPa.</div>
        <div id="areaB"></div>
        <div class="actions left">
          <button type="button" id="addRowB" class="btn">Agregar lectura B</button>
        </div>
      </div>

      <div class="actions">
        <button class="btn" type="submit">Guardar lecturas</button>
        <button class="btn btn-secondary" type="reset">Limpiar</button>
      </div>
      <div class="inline-status" id="resistStatus" aria-live="polite"></div>
    </form>

    <div class="card">
      <h3>Resistencias iniciales (log–log)</h3>
      <img id="chartResistImg" class="chart-img" alt="Gráfico Resistencias (Python)" />
      <canvas id="chartResistCv" class="chart-cv" width="920" height="560"></canvas>
    </div>
  </section>

  <!-- TAB 3: PERNOS -->
  <section id="tab-pernos" class="panel" role="tabpanel">
    <div class="panel-head">
      <h2>Instalación de Pernos</h2>
      <p class="muted">Registra tipo y cantidad instalada por labor.</p>
    </div>
    <form id="formPernos" class="card">
      <div class="grid">
        <div>
          <label>Fecha</label>
          <input type="date" name="fecha" required />
        </div>
        <div>
          <label>Hora</label>
          <input type="time" name="hora" required />
        </div>
        <div>
          <label>Labor</label>
          <input type="text" name="labor" required />
        </div>
        <div>
          <label>Nivel</label>
          <input type="text" name="nivel" required />
        </div>
        <div class="col-span-2">
          <label>Tipo de perno</label>
          <div class="checks">
            <label class="check"><input type="checkbox" id="chkHel" /> P. Helicoidal</label>
            <label class="check"><input type="checkbox" id="chkSw" /> P. Swellex</label>
          </div>
          <small class="hint">Marca uno o ambos e ingresa cantidades.</small>
        </div>
        <div>
          <label>Cantidad Helicoidal</label>
          <input type="number" name="cantHel" id="cantHel" min="0" step="1" value="0" disabled />
        </div>
        <div>
          <label>Cantidad Swellex</label>
          <input type="number" name="cantSw" id="cantSw" min="0" step="1" value="0" disabled />
        </div>
        <div class="col-span-2">
          <label>Observaciones</label>
          <input type="text" name="obs" placeholder="Opcional" />
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="submit">Guardar</button>
        <button class="btn btn-secondary" type="reset">Limpiar</button>
      </div>
      <div class="inline-status" id="pernosStatus" aria-live="polite"></div>
    </form>
  </section>

  <!-- TAB 4: BD (por mes) -->
  <section id="tab-bd" class="panel" role="tabpanel">
    <div class="panel-head">
      <h2>Base de Datos (por mes)</h2>
      <p class="muted">Filtra por mes y gestiona registros.</p>
    </div>
    <div class="card">
      <div class="grid">
        <div>
          <label>Mes</label>
          <input type="month" id="fMes" />
        </div>
        <div></div>
        <div class="col-span-2 actions left">
          <button id="btnFiltrar" class="btn" type="button">Aplicar mes</button>
          <button id="btnLimpiarFiltro" class="btn btn-secondary" type="button">Ver todo</button>
          <button id="btnBDPDF" class="btn btn-secondary" type="button">Exportar PDF</button>
          <button id="btnBorrarTodo" class="btn btn-danger" type="button">Borrar TODO</button>
        </div>
      </div>
      <p class="hint">Tip: El filtro por mes evita conflictos de rangos.</p>
    </div>

    <div class="card">
      <h3>Slump y T°</h3>
      <div class="table-wrap">
        <table class="table" id="tblSlump">
          <thead>
          <tr>
            <th>Fecha</th><th>Hora Slump</th><th>Labor</th><th>Nivel</th>
            <th>Slump</th><th>T°</th><th>Presión</th><th>Mixer</th>
            <th>HS</th><th>H_LL</th><th>Demora</th><th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Resistencias</h3>
      <div class="table-wrap">
        <table class="table" id="tblResist">
          <thead>
          <tr>
            <th>Fecha</th><th>Hora</th><th>Labor</th><th>Nivel</th><th>Método</th><th>Edad</th><th>MPa</th><th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Pernos</h3>
      <div class="table-wrap">
        <table class="table" id="tblPernos">
          <thead>
          <tr>
            <th>Fecha</th><th>Hora</th><th>Labor</th><th>Nivel</th><th>Helicoidal</th><th>Swellex</th><th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- TAB 5: REPORTE -->
  <section id="tab-reporte" class="panel" role="tabpanel">
    <div class="panel-head">
      <h2>Reporte diario</h2>
      <p class="muted">Reporte por día (WhatsApp / PDF).</p>
    </div>
    <div class="card">
      <div class="grid">
        <div>
          <label>Día</label>
          <input type="date" id="rDia" />
        </div>
        <div></div>
        <div class="col-span-2 actions left">
          <button id="btnReporte" class="btn" type="button">Actualizar</button>
          <button id="btnReporteTodo" class="btn btn-secondary" type="button">Hoy</button>
          <button id="btnPDF" class="btn btn-secondary" type="button">Exportar PDF</button>
        </div>
      </div>

      <div class="kpis-2">
        <div class="kpi-big">
          <div class="kpi-title">Temperatura Promedio</div>
          <div class="kpi-value" id="kpiTempProm">—</div>
          <div class="kpi-sub muted" id="kpiTempExtra">Min — / Max —</div>
        </div>
        <div class="kpi-big">
          <div class="kpi-title">Pernos Instalados</div>
          <div class="kpi-value" id="kpiPernosTotal">0</div>
          <div class="kpi-sub muted" id="kpiPernosExtra">Helicoidal 0 / Swellex 0</div>
        </div>
      </div>
      <p class="hint">En celular: Exportar PDF → Guardar como PDF → Compartir.</p>
    </div>

    <div class="grid-2">
      <div class="card">
        <h3>Slump (") promedio por Labor</h3>
        <img id="chartSlumpImg" class="chart-img" alt="Gráfico Slump (Python)" />
        <canvas id="chartSlumpCv" class="chart-cv" width="920" height="560"></canvas>
      </div>
      <div class="card">
        <h3>Presión de aire promedio por Labor</h3>
        <img id="chartAireImg" class="chart-img" alt="Gráfico Aire (Python)" />
        <canvas id="chartAireCv" class="chart-cv" width="920" height="560"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>Resistencias iniciales (log–log)</h3>
      <img id="chartResistImgReport" class="chart-img" alt="Gráfico Resistencias (Python)" />
      <canvas id="chartResistCvReport" class="chart-cv" width="920" height="560"></canvas>
      <div class="hint mt-12">Se actualiza automáticamente cuando guardas Resistencias o cuando presionas “Actualizar”.</div>
    </div>

    <div class="card">
      <h3>Resumen</h3>
      <div id="resumenReporte" class="muted"></div>
    </div>
  </section>
</main>

<footer class="footer">
  <span>CE Offline • IndexedDB</span>
  <span id="offlineBadge" class="badge">Online</span>
</footer>

<script src="app.js"></script>
<!-- PyScript -->
<script type="py" src="report.py" config="pyscript.json" worker></script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }
</script>
</body>
</html>
